version: "3.9"

services:
  postgres_db: 
    image: postgres:14-alpine 
    container_name: postgres_fraud_db
    restart: always 
    ports:
      - "5432:5432" 
    environment:
      POSTGRES_USER: 'postgres'       
      POSTGRES_PASSWORD: '123'        
      POSTGRES_DB: ecomm_fraud_db     
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - fraud_detection_network
      
  pyspark_writer:
    build:
      context: .
      dockerfile: Dockerfile.pyspark
    container_name: pyspark_writer_fraud
    volumes:
      - .:/app 
    depends_on:
      - postgres_db
    networks:
      - fraud_detection_network
    # ไม่ต้องรัน command อัตโนมัติ ให้รันด้วยตัวเองภายหลัง
    command: tail -f /dev/null
  
  metabase-db:
    image: postgres:16-alpine
    container_name: metabase-app-db
    restart: always
    environment:
      POSTGRES_DB: metabase
      POSTGRES_USER: metabaseuser
      POSTGRES_PASSWORD: your_strong_db_password # <--- CHANGE THIS
    volumes:
      - metabase_db_data:/var/lib/postgresql/data
    networks:
      - fraud_detection_network

  # -------------------------------------------------------------------------
  # 6. Metabase Application Server
  # -------------------------------------------------------------------------
  metabase-app:
    image: metabase/metabase:latest
    container_name: metabase-server
    restart: always
    depends_on:
      - metabase-db
      - postgres_db # Ensure Data Warehouse is also up
    ports:
      - "3000:3000"
    environment:
      # Connect Metabase to its application database
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_HOST: metabase-db
      MB_DB_PORT: 5432
      MB_DB_USER: metabaseuser
      MB_DB_PASS: your_strong_db_password # <--- USE THE SAME PASSWORD
      JAVA_TIMEZONE: Asia/Bangkok # Change to your preferred timezone
    networks:
      - fraud_detection_network

networks:
  fraud_detection_network:
    external: true
      
volumes:
  postgres_data:
  metabase_db_data: